<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannon.js and Three.js Example</title>
    <script type="module">
        import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/+esm';
        import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';

        // Cannon.js World
        const world = new CANNON.World();
        world.gravity.set(0,-9.82,0);

        // サイズを指定
        const width = 960;
        const height = 540;
        // Three.js Scene, Camera, and Renderer
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight);
        const renderer = new THREE.WebGLRenderer({ canvas: document.querySelector("#cannonCanvas") });
        renderer.setSize(width, height);

        // Ground

                  const groundBody = new CANNON.Body({
            mass: 0, // static
            shape: new CANNON.Box(
              new CANNON.Vec3(10, 0.01, 10), // size
            ),
            material: new CANNON.Material({
              restitution: 0.9,
            }),
          });
          world.addBody(groundBody);  

        // Sphere
        const sphereGeometry = new THREE.SphereGeometry(1,32,32);
        const sphereMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        scene.add(sphere);

        const sphereShape = new CANNON.Sphere(1);
        const sphereBody = new CANNON.Body({ mass: 5 });
        sphereBody.addShape(sphereShape);
        sphereBody.position.set(0, 5, 0);
        world.addBody(sphereBody);

        //ライト設定
        function initLight() {   
            //ライトの取得（色、強度）
            var light = new THREE.DirectionalLight(0xfafad2, 1);
            //ライト位置
            light.position.set(2, 7, 2);
            //画面へのライトの追加
            scene.add(light);
            
            //環境光の取得
            var amb = new THREE.AmbientLight(0xfafad2);
            //画面への環境光の追加
            scene.add(amb);
            renderer.render(scene,camera);
        }

        // Time step and iterations
        const fixedTimeStep = 1.0 / 60.0;
        const maxSubSteps = 3;

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            world.step(fixedTimeStep, fixedTimeStep, maxSubSteps);

            // Update Three.js objects based on Cannon.js objects
            sphere.position.copy(sphereBody.position);
            sphere.quaternion.copy(sphereBody.quaternion);

            camera.position.set(0, 5, -7);
            camera.lookAt(0, 5, 0);

            renderer.render(scene, camera);
        }

        initLight();  // こちらでinitLight()を呼び出す

        animate();
    </script>
</head>
<body>
    <canvas id="cannonCanvas"></canvas>
</body>
</html>
