<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
        "cannon": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/+esm"
      }
    }
  </script>
  <script type="module">

import * as THREE from "three";
import * as CANNON from "cannon";

const width = 960;
const height = 540;

const renderer = new THREE.WebGLRenderer({
  canvas: document.querySelector("#myCanvas"),
  alpha: true
});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(width, height);

const world = new CANNON.World();
world.gravity.set(0, -9.82, 0);
world.broadphase = new CANNON.NaiveBroadphase(world);
world.solver.iterations = 10;
world.solver.tolerance = 0.1;

const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(45, width / height);
camera.position.set(0, -150, 1200);

const geometry = new THREE.BoxGeometry(200, 20, 250);

const textures = [
  "image/19qfb31hpnesocsw.jpg",
  "image/41Cv1TkZ4rL.jpg",
  "image/41hukSK1BFL._SY445_SX342_.jpg",
  "image/41JQYfaFSaL._SY445_SX342_.jpg",
  "image/41m6VUbVICL._SY445_SX342_.jpg",
  "image/41risuMn0L._SY445_SX342_.jpg",
  "image/41v113triqL._SY445_SX342_.jpg",
  "image/41zeltJV2bL._SY445_SX342_.jpg",
  "image/41Yn5sF1yGS._SY445_SX342_.jpg",
  "image/51BPHWfKpVL._SY445_SX342_.jpg",
  "image/51BZNoAp6iL._SL500_.jpg",
  "image/51VcmFf+4YL._SY445_SX342_.jpg",
  "image/51pHmv0qPjL._SY445_SX342_.jpg",
  "image/51ytpgtG4EL._SL500_.jpg",
  "image/61wJRcSL8pL._SY445_SX342_.jpg",
  "image/512vTFXAxrL._SY445_SX342_.jpg",
  "image/611C8NPLQlL._AC_UF1000,1000_QL80_.jpg",
  "image/512UuB057tL._SY445_SX342_.jpg",
  "image/5191I62Y1JL._AC_UF1000,1000_QL80_.jpg",
  "image/034924.jpg",
  "image/9784053038449.jpg",
  "image/41ZrFVasdPL._SY445_SX342_.jpg"
];

let floatingBox = null;
let moveDirection2 = 10;
let moveDirection3 = 24;
let score = 0;

function moveboxX() {
  floatingBox.position.x += moveDirection2;
  if (floatingBox.position.x >= 450 || floatingBox.position.x <= -450) {
    moveDirection2 = -moveDirection2;
  }
}

function moveboxY() {
  floatingBox.position.y -= moveDirection3;
}

function createBox() {
  const randomTexturePath = textures[Math.floor(Math.random() * textures.length)];
  const texture = new THREE.TextureLoader().load(randomTexturePath);
  const material = new THREE.MeshBasicMaterial({ map: texture });

  const box = new THREE.Mesh(geometry, material);
  box.position.set(0, 200, 0);
  scene.add(box);
  floatingBox = box;

  
}

const landedBoxes = [];
let state = "x";

const tableTexture = "image/66193d1aeb0e1a1ab36b2687c79e63f7_t.jpeg";
const tableMaterial = new THREE.MeshBasicMaterial({map: new THREE.TextureLoader().load(tableTexture) });
const tableGeometry = new THREE.BoxGeometry(1800, 80, 1500);
const table = new THREE.Mesh(tableGeometry,tableMaterial);
table.position.set(50,-540,0);
scene.add(table);


function animate() {
  requestAnimationFrame(animate);
  
  world.step(1 / 60);

  if (state === "y") {
    moveboxY();
    if (floatingBox.position.y <= -480 + 20 * landedBoxes.length) {
      landedBoxes.push(floatingBox);
      createBox();
      state = "x";
      score += 10;
      document.getElementById('score').innerText = 'Score: ' + score;
    }
  } else if (state === "x") {
    moveboxX();
  }

  renderer.render(scene, camera);
}

createBox();
animate();

document.addEventListener("click", () => {
  state = "y"; 
});

document.getElementById('score').innerText = 'Score: ' + score;

// ブラックボードの画像をシーンの背景に設定
const bgTexture = new THREE.TextureLoader().load("image/_blackboard_1.png");
scene.background = bgTexture;

</script>
</head>
<body>
  <div id ="score"></div>
  <canvas id="myCanvas"></canvas>
</body>
</html>
